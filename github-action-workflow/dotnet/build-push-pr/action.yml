name: build-push
description: ''

inputs:
  repository:
    description: The owner and repository name
    required: false
    type: string
    default: ${{ github.repository }}
  base_ref:
    description: The branch or tag ref or commit SHA that be base code.
    required: false
    type: string
    default: ${{ github.base_ref || 'main' }}
  target_ref:
    description: The branch or tag ref or commit SHA that will be merged to base code.
    required: false
    type: string
    default: ${{ github.head_ref || github.ref_name }}
  code_language:
    description: The program language of this repository
    required: true
    type: string
  application_name:
    description: Name of application
    required: true
    type: string
  dotnet_version:
    description: dotnet version
    type: string
    default: 8.0.x
  infra_repo_config:
    description: the config folder that will be changed
    type: string
  gh_access_token:
    description: Gihub Access Token
    required: true
  aws_access_key_id:
    description: Aws key id
    required: true
  aws_secret_access_key:
    description: aws access key
    required: true
  aws_region:
    description: aws access key
    required: true
  role_to_assume:
    description: aws access key
    required: true
  ecr_repository:
    description: ecr location
    required: true
  infra:
    description: infra
    required: true
  token_image_update:
    description: token image update
    required: true
  docker_file_path:
    description: dockerfile path
    required: true
outputs:
  metadatatag:
    description: Docker Tags to use
    value: ${{ steps.metadataoutputtags.outputs.tags }}
  metadatalabel:
    description: Docker labels
    value: ${{ steps.metadataoutputlabel.outputs.labels }}
  metadataversion:
    description: Docker Version
    value: ${{ steps.metadataoutputversion.outputs.version }}
runs:
  using: composite
  steps:
    - name: Setup ${{ inputs.code_language }}
      uses: pi-financial/github-action-workflow/dotnet/setup@main
      with:
        repository: ${{ inputs.repository }}
        base_ref: ${{ inputs.base_ref }}
        target_ref: ${{ inputs.target_ref }}
        gh_access_token: ${{ inputs.gh_access_token }}
        dotnet_version: ${{ inputs.dotnet_version }}
    - name: Install Dependencies
      uses: pi-financial/github-action-workflow/dotnet/restore@main
      with:
        application_name: ${{ inputs.application_name }}
        gh_access_token: ${{ inputs.gh_access_token }}
    - name: Authenticate AWS
      id: authen-aws
      uses: pi-financial/github-action-workflow/authen-aws@main
      with:
        aws_access_key_id: ${{ inputs.aws_access_key_id }}
        aws_secret_access_key: ${{ inputs.aws_secret_access_key }}
        aws_region: ${{ inputs.aws_region }}
        role_to_assume: ${{ inputs.role_to_assume}}

    - name: Docker MetaData
      id: metadata
      uses: pi-financial/github-action-workflow/docker/metadata@main
      with:
        docker_file_path: ${{ inputs.docker_file_path }}
        docker_context: ${{ inputs.docker_context }}
        ecr_registry: ${{ steps.authen-aws.outputs.ecr-registry }}
        ecr_repository: ${{ inputs.ecr_repository }}


    # outputting to next job
    - name: Docker MetaData output tags
      shell: bash
      id: metadataoutputtags
      run: echo "metadatatag=${{ steps.metadata.outputs.tags }}" >> $GITHUB_OUTPUT

    - name: Docker MetaData output label
      shell: bash
      id: metadataoutputlabel
      run: echo "metadatalabel=${{ steps.metadata.outputs.labels }}" >> $GITHUB_OUTPUT

    - name: Docker MetaData output version
      shell: bash
      id: metadataoutputversion
      run: echo "metadataversion=${{ steps.metadata.outputs.version }}" >> $GITHUB_OUTPUT

    - name: Build & Push Docker Image
      id: build-image
      uses: pi-financial/github-action-workflow/docker/build@main
      with:
        docker_file_path: ${{ inputs.docker_file_path }}
        docker_context: ${{ inputs.docker_context }}
        ecr_registry: ${{ steps.authen-aws.outputs.ecr-registry }}
        ecr_repository: ${{ inputs.ecr_repository }}
        tags: ${{ steps.metadata.outputs.tags }}
        labels: ${{ steps.metadata.outputs.labels }}
        version: ${{ steps.metadata.outputs.version }}
        
    - name: Make Artifact Directory
      shell: bash
      run: mkdir -p forgithub/artifact

    - name: pass image tag into txt
      shell: bash
      run: echo ${{ steps.metadata.outputs.version }} > forgithub/artifact/imagetag.txt

    - name: Environment Variables
      shell: bash
      run: |
        ARTIFACTS_SHA=${{ github.head_ref }}.${{ github.sha }}
        BUILD_ARTIFACTS=imagetag_${ARTIFACTS_SHA}
        echo "ARTIFACTS_DIR=$ARTIFACTS_DIR" >> $GITHUB_ENV

    - uses: actions/upload-artifact@v3
      with:
        name: imagetag_${{ inputs.infra_repo_config }}.${{ github.head_ref }}.${{github.event.pull_request.number}}
        path: forgithub/artifact/imagetag.txt